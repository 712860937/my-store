<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ØªÙˆØ±ÙŠØ¯ Ø¨Ø¶Ø§Ø¹Ø© | Ø§Ù„Ø³ÙŠØ§Ø±ÙŠ</title>
    <style>
        :root { --gold: #d4af37; --dark: #121212; }
        body { font-family: sans-serif; background: #f4f4f4; margin: 0; padding: 70px 15px; direction: rtl; }
        .header { background: var(--dark); color: var(--gold); padding: 15px; position: fixed; top: 0; left: 0; width: 100%; text-align: center; font-weight: bold; z-index: 100; border-bottom: 2px solid var(--gold); }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 500px; margin: auto; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn-save { width: 100%; padding: 15px; background: var(--dark); color: var(--gold); border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
    </style>
    
</head>
<body>
<header>  
    <h2 style="margin:0; font-size: 1.2rem; text-align: center; width: 100%;">ğŸ’ Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ© Ø§Ù„Ø³ÙŠØ§Ø±ÙŠ</h2>
    <a href="admin.html" class="back-btn">Ø®Ø±ÙˆØ¬ â†</a>  
  
</header>  
<div class="header">ğŸšš ØªÙˆØ±ÙŠØ¯ Ø¨Ø¶Ø§Ø¹Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù…Ø®Ø²Ù†</div>

<div class="card">
    <label>Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù Ù…Ù† Ø§Ù„Ù…Ø®Ø²Ù†:</label>
    <select id="productSelect"><option value="">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù...</option></select>
    
    <input type="number" id="buyQty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø´ØªØ±Ø§Ø©">
    <input type="number" id="buyCost" placeholder="Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
    <input type="text" id="supplier" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ Ø£Ùˆ Ø§Ù„ØªØ§Ø¬Ø±">
    
    <button class="btn-save" id="btnUpdateStock">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²Ù† ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø´Ø±ÙˆØ©</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot, updateDoc, doc, addDoc } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

    const firebaseConfig = {  
        apiKey: "AIzaSyAD5GAic-ioZhetXQQ4u8shXScxTZO2DoI",  
        authDomain: "elite-store-8f693.firebaseapp.com",  
        projectId: "elite-store-8f693",  
        storageBucket: "elite-store-8f693.firebasestorage.app",  
        messagingSenderId: "227353365436",  
        appId: "1:227353365436:web:e662600dac0e83fe6739b9",  
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const pSelect = document.getElementById('productSelect');

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    onSnapshot(collection(db, "products"), (snap) => {
        pSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± ØµÙ†ÙØ§Ù‹ --</option>';
        snap.forEach(d => {
            const p = d.data();
            pSelect.innerHTML += `<option value="${d.id}" data-stock="${p.stock}" data-name="${p.name}">${p.name} (Ø§Ù„Ø­Ø§Ù„ÙŠ: ${p.stock})</option>`;
        });
    });

    document.getElementById('btnUpdateStock').onclick = async () => {
        const pId = pSelect.value;
        const qty = parseInt(document.getElementById('buyQty').value);
        const cost = document.getElementById('buyCost').value;
        const supplier = document.getElementById('supplier').value || "ØªØ§Ø¬Ø± Ù…Ø¬Ù‡ÙˆÙ„";

        if(!pId || isNaN(qty)) return alert("Ø¹Ø¨Ù‘ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙŠØ§ Ø²Ø¹ÙŠÙ…!");

        const selectedOpt = pSelect.options[pSelect.selectedIndex];
        const oldStock = parseInt(selectedOpt.getAttribute('data-stock'));
        const pName = selectedOpt.getAttribute('data-name');

        // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²Ù†
        const pRef = doc(db, "products", pId);
        let updateData = { stock: oldStock + qty };
        if(cost) updateData.cost = parseFloat(cost);
        
        await updateDoc(pRef, updateData);

        // 2. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (Inbound)
        await addDoc(collection(db, "stock_logs"), {
            productName: pName,
            quantity: qty,
            supplier: supplier,
            date: new Date(),
            type: "Ø´Ø±Ø§Ø¡/ØªÙˆØ±ÙŠØ¯"
        });

        alert(`ØªÙ…! Ø§Ù„Ù…Ø®Ø²Ù† Ø§Ù„Ø­ÙŠÙ† ÙÙŠÙ‡ ${oldStock + qty} Ù…Ù† ${pName}`);
        document.getElementById('buyQty').value = "";
    };
</script>
</body>
</html>
