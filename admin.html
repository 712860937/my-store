<!DOCTYPE html>  
<html lang="ar" dir="rtl">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>ุฅุฏุงุฑุฉ ุงูุฅูุจุฑุงุทูุฑูุฉ | ุงูุณูุงุฑู</title>  
    <link rel="stylesheet" href="style.css">
</head>  
<body>  

<div class="navbar">  
    <div class="dropdown">  
        <button onclick="toggleDropdown()" class="dropbtn">ุงููุงุฆูุฉ โฐ</button>  
        <div id="myDropdown" class="dropdown-content">  
            <a href="project.html">๐ฆ ุฅุฏุงุฑุฉ ุงูุจุถุงุฆุน</a>  
            <a href="stock_in.html">๐ ุชูุฑูุฏ ุจุถุงุฆุน (ูุดุชุฑูุงุชู)</a>

            <a href="purchases.html">๐ฐ ุณุฌู ุงููุดุชุฑูุงุช</a> 
            <a href="debts.html">ุงูุฏููู</a> 
            <a href="AI_Scanner.html">ุงููุงุณุญ ุงูุถูุฆู</a>
            <a href="reports.html">๐ุงูุชูุงุฑูุฑ </a>
 
            <a href="#" onclick="window.print()">๐จ๏ธ ุทุจุงุนุฉ</a>  
            <a href="#" onclick="logout()" style="color: var(--red);">Logout ๐ช</a>
        </div>  
    </div>  
    <div style="color:var(--gold); font-weight: bold; font-size: 0.9rem;">โ๏ธ ุฅูุจุฑุงุทูุฑูุฉ ุงูุณูุงุฑู โ๏ธ</div>  
    <div style="position: relative; cursor: pointer; font-size: 1.3rem;" onclick="toggleOrders()">
        ๐ <span id="orderCount" class="badge">0</span>
    </div>
</div>  

<div class="dashboard">  
    <div class="stat-card" onclick="showLowStock()" style="border-right: 5px solid #e74c3c; cursor:pointer;">
    ุฃุตูุงู ููููุต ๐จ
    <span id="lowStockCount">0</span>
    <small style="display:block; font-size: 0.6rem; color: #666;">ุงุถุบุท ููุนุฑุถ</small>
</div>

<div class="stat-card" onclick="window.showVipList()" style="border-right: 5px solid #2ecc71; cursor:pointer; background: linear-gradient(145deg, #121212, #1a1a1a);">
    ูุจุงุฑ ุงูุนููุงุก ๐๏ธ
    <span id="topCustomerName" style="color: var(--gold);">...</span>
    <small id="topCustomerAmount" style="display:block; font-size: 0.7rem; color: #fff; margin-top:4px;"></small>
    <small style="display:block; font-size: 0.6rem; color: var(--gold); opacity: 0.7;">๐ ุงุถุบุท ูุนุฑุถ ุงููุงุฆูุฉ</small>
</div>

<div id="vipModal" class="confirm-box" style="display: none;">
    <div class="confirm-content" style="background: #121212; color: var(--gold); border: 2px solid var(--gold); max-height: 80vh; display: flex; flex-direction: column;">
        <h3 style="margin-top: 0; border-bottom: 1px solid var(--gold); padding-bottom: 10px;">๐ ูุงุฆูุฉ ูุจุงุฑ ุงูุนููุงุก</h3>
        <div id="vipListContent" style="overflow-y: auto; flex: 1; text-align: right; padding: 10px;">
            </div>
        <button onclick="document.getElementById('vipModal').style.display='none'" style="margin-top: 15px; padding: 10px; background: var(--gold); color: black; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">ุฅุบูุงู</button>
    </div>
</div>
<div class="stat-card" onclick="window.showTopSelling()" style="border-right: 5px solid var(--gold); cursor:pointer;">
    ุงูุฃูุซุฑ ูุจูุนุงู ๐ฅ
    <span id="bestSellerName">...</span>
    <small style="display:block; font-size: 0.6rem; color: #666;">ุงุถุบุท ููุชูุงุตูู</small>
</div>

<div id="topSellingModal" class="confirm-box" style="display: none;">
    <div class="confirm-content" style="background: white; color: var(--dark); border: 2px solid var(--gold); max-height: 80vh; display: flex; flex-direction: column;">
        <h3 style="margin-top: 0; color: var(--gold); border-bottom: 2px solid #eee; padding-bottom: 10px;">๐ฅ ุงูุฃุตูุงู ุงูุฃูุซุฑ ุทูุจุงู</h3>
        <div id="topSellingList" style="overflow-y: auto; flex: 1; text-align: right; padding: 10px;">
            </div>
        <button onclick="document.getElementById('topSellingModal').style.display='none'" style="margin-top: 15px; padding: 12px; background: var(--dark); color: var(--gold); border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">ุฅุบูุงู</button>
    </div>
</div>


 <div class="stat-card" onclick="window.location.href='project.html'" style="cursor:pointer;">
    ุงูุฃุตูุงู
    <span id="itemCount">0</span>
</div>
</div>  

<div class="admin-card">
    <h3 style="text-align:center; margin-top: 0;">โ ุฅุถุงูุฉ ุตูู ุฌุฏูุฏ</h3>  
    <div class="form-grid">  
    <div style="grid-column: span 2; position: relative;">
        <input type="text" id="p-name" placeholder="ุงุณู ุงูููุชุฌ" style="width: 100%;" autocomplete="off">
        <div id="suggestions" style="position: absolute; top: 100%; left: 0; background: white; border: 1px solid var(--gold); max-height: 150px; overflow-y: auto; width: 100%; z-index: 9999; display: none; border-radius: 0 0 8px 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);"></div>
    </div>
      
        <input type="number" id="p-cost" placeholder="ุณุนุฑ ุงูุดุฑุงุก">  
        <input type="number" id="p-price" placeholder="ุณุนุฑ ุงูุจูุน">  
        <input type="number" id="p-stock" placeholder="ุงููููุฉ">  
        <input type="date" id="p-expiry" placeholder="ุชุงุฑูุฎ ุงูุงูุชูุงุก">  
        <input type="text" id="p-img" style="grid-column: span 2;" placeholder="ุฑุงุจุท ุงูุตูุฑุฉ">  
    </div>  
    <button class="main-btn" id="btnSave">ุญูุธ ุงูุตูู</button>  
</div>

<div id="orderModal" class="modal">
    <div class="modal-header">๐ฅ ุงูุทูุจุงุช ุงูุฌุฏูุฏุฉ</div>
    <div id="ordersContainer" class="modal-content">ูุง ุชูุฌุฏ ุทูุจุงุช..</div>
</div>

<div id="voice-trigger" class="float-mic">  
    <span id="mic-icon">๐ค</span>  
    <div class="pulse-ring"></div>  
</div>  

<script type="module">  
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";  
    import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";  
  import { query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";
    const firebaseConfig = {  
      apiKey: "AIzaSyAD5GAic-ioZhetXQQ4u8shXScxTZO2DoI",  
      authDomain: "elite-store-8f693.firebaseapp.com",  
      projectId: "elite-store-8f693",  
      storageBucket: "elite-store-8f693.firebasestorage.app",  
      messagingSenderId: "227353365436",  
      appId: "1:227353365436:web:e662600dac0e83fe6739b9",  
    };  
  
    const app = initializeApp(firebaseConfig);  
    const db = getFirestore(app);  
  
        const saveProduct = async () => {  
        const name = document.getElementById('p-name').value.trim();  
        const cost = parseFloat(document.getElementById('p-cost').value);  
        const price = parseFloat(document.getElementById('p-price').value);  
        const stock = parseInt(document.getElementById('p-stock').value) || 0;  
        const expiry = document.getElementById('p-expiry').value;
        const image = document.getElementById('p-img').value;

        if (!name || isNaN(cost) || isNaN(price)) {  
            speak("ุงูุจูุงูุงุช ูุงูุตุฉ");  
            return;  
        }

        const q = query(collection(db, "products"), where("name", "==", name));
        const snap = await getDocs(q);

        let clearDone = false; // ุนูุงูุฉ ููุชุฃูุฏ ูู ุงููุณุญ

        if (!snap.empty) {
            if (confirm(`ุงูุตูู "${name}" ููุฌูุฏุ ูู ุฃุถูู ุงููููุฉุ`)) {
                const ref = snap.docs[0];
                const oldStock = ref.data().stock || 0;
                await updateDoc(doc(db, "products", ref.id), {
                    stock: oldStock + stock,
                    cost, price, expiry, image
                });
                speak("ุชู ุชุญุฏูุซ ุงูููุฌูุฏ");
                showNotif(`โ ุชู ุชุญุฏูุซ ูููุฉ ุงูุตูู "${name}"`);
                clearDone = true; 
            } else {
                speak("ุชู ุงูุฅูุบุงุก");
            }
        } else {
            await addDoc(collection(db, "products"), { name, cost, price, stock, expiry, image });
            speak("ุชู ุญูุธ ุงูุฌุฏูุฏ");
            clearDone = true;
        }

        // ุฅุฐุง ุชูุช ุงูุนูููุฉ ุจูุฌุงุญุ ุตูุฑ ูู ุงูุฎุงูุงุช
        if (clearDone) {
            document.getElementById('p-name').value = "";
            document.getElementById('p-cost').value = "";
            document.getElementById('p-price').value = "";
            document.getElementById('p-stock').value = "";
            document.getElementById('p-expiry').value = "";
            document.getElementById('p-img').value = "";
            showNotif("ุชู ุชุตููุฑ ุงูุฎุงูุงุช โ");
        }
            
    };


    document.getElementById('btnSave').onclick = saveProduct;
    
    
    onSnapshot(collection(db, "products"), (s) => {  
        let tc = 0, tp = 0, count = 0;  
        s.forEach(d => {  
            const p = d.data(); 
if (p.stock <= 5) {
    console.warn(`ุชูุจูู: ${p.name} ุฃูุดู ุนูู ุงูููุงุฏ`);
    speak(`ุชูุจููุ ุตูู ${p.name} ุฃูุดู ุนูู ุงูููุงุฏ`);
}            
            tc += (p.cost * p.stock); tp += ((p.price - p.cost) * p.stock);  
            count++;  
        });  
        document.getElementById('totalCosts').innerText = tc.toFixed(2) + "$";  
        document.getElementById('netProfit').innerText = tp.toFixed(2) + "$";  
        document.getElementById('itemCount').innerText = count;  
    });  
  // ุญุทูุชู ูู ููุง ูุง ูุญุด:
// 1. ูุธุงู ุงูุงูุชุฑุงุญุงุช ุงูุฐูู
const nameInput = document.getElementById('p-name');
const suggestionsDiv = document.getElementById('suggestions');

nameInput.addEventListener('input', async () => {
    const value = nameInput.value.trim();
    suggestionsDiv.innerHTML = "";
    if (!value) { suggestionsDiv.style.display = "none"; return; }

    const q = query(collection(db, "products"));
    const snapshot = await getDocs(q);
    const matches = snapshot.docs.map(d => d.data().name).filter(n => n.includes(value));

    if (matches.length > 0) {
        matches.forEach(match => {
            const div = document.createElement('div');
            div.className = "suggestion-item";
            div.textContent = match;
            div.onclick = () => { nameInput.value = match; suggestionsDiv.style.display = "none"; };
            suggestionsDiv.appendChild(div);
        });
        suggestionsDiv.style.display = "block";
    } else {
        suggestionsDiv.style.display = "none";
    }
});

// 2. ููุฏ ุฅุบูุงู ุงููุงุฆูุฉ ุฅุฐุง ุถุบุทุช ุจุฑุง ุงููุฑุจุน
document.addEventListener('click', (e) => { if (e.target !== nameInput) suggestionsDiv.style.display = "none"; });

    const rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();  
    rec.lang = 'ar-SA'; rec.continuous = true;  
    let listening = false;  
  
    document.getElementById('voice-trigger').onclick = () => {  
        if(!listening) { rec.start(); listening = true; speak("ูุนู"); }  
        else { rec.stop(); listening = false; }  
    };  
  
    rec.onstart = () => document.getElementById('voice-trigger').classList.add('mic-active');  
    rec.onend = () => { if(listening) rec.start(); else document.getElementById('voice-trigger').classList.remove('mic-active'); };  
  //ูุดุบู ุงูุตูุช
    rec.onresult = (event) => {  
        let cmd = event.results[event.results.length - 1][0].transcript.toLowerCase();  
        cmd = cmd.replace(/[ู-ูฉ]/g, d => "ููกูขูฃูคูฅูฆูงูจูฉ".indexOf(d));  
  
        if (cmd.includes("ุฃุถู") || cmd.includes("ุงุถู")) {  
            const nums = cmd.match(/\d+/g) || [];  
            let namePart = cmd.split(/ุฃุถู|ุงุถู/)[1];  
            let name = namePart.split(/\d/)[0].trim();  
            if (name) document.getElementById('p-name').value = name;  
            if (nums[0]) document.getElementById('p-cost').value = nums[0];  
            if (nums[1]) document.getElementById('p-price').value = nums[1];  
            if (nums[2]) document.getElementById('p-stock').value = nums[2];  
            speak("ุชู ุงูุชุฌููุฒุ ุงุญูุธ ุงูุขู");  
        }  
        if (cmd.includes("ุงุญูุธ") || cmd.includes("ุญูุธ")) saveProduct();  
    };  
  
    function speak(t) { window.speechSynthesis.speak(new SpeechSynthesisUtterance(t)); }  
    
    window.toggleDropdown = () => document.getElementById("myDropdown").classList.toggle("show");  
    window.toggleOrders = () => {
        const m = document.getElementById('orderModal');
        m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
    };



window.processOrder = async (orderId, action) => {
    const orderRef = doc(db, "orders", orderId);
    const orderSnap = await getDoc(orderRef);
    if (!orderSnap.exists()) return;
    const o = orderSnap.data();

    // ุฅุฎูุงุก ููุฏุงู ุงูุทูุจุงุช ูููุน ุงููุฎุจุทุฉ
    document.getElementById('orderModal').style.display = 'none';

    if (action === 'reject') {
        if(confirm("ุญุฐู ุงูุทูุจุ")) await deleteDoc(orderRef);
        return;
    }

    // ุฌูุจ ุงูุฏูู ุงูุณุงุจู (ุจุงูุจุญุซ ุนู ุงุณู ุงูุนููู)
    const qDebt = query(collection(db, "debts"), where("customer", "==", o.customer));
    const debtSnap = await getDocs(qDebt);
    let oldDebt = 0; let debtDocId = null;
    if (!debtSnap.empty) { 
        oldDebt = debtSnap.docs[0].data().amount || 0; 
        debtDocId = debtSnap.docs[0].id; 
    }

    // ุนุฑุถ ุจูุงูุงุช ุงูุนููู ูู ุงููุงูุฐุฉ ุงูููููุฉ (ูุน ุงูุฑูู)
    document.getElementById('confirmBody').innerHTML = `
        <b>๐ค ุงูุนููู:</b> ${o.customer}<br>
        <b>๐ ุงููุงุชู:</b> ${o.phone || "ุบูุฑ ูุณุฌู"}<br>
        <b>๐ฐ ุทูุจ ุฌุฏูุฏ:</b> ${o.total}$<br>
        <b>๐ต ูุฏููุน ุงูุขู:</b> ${o.paid}$<br>
        <b>๐ ูุชุจูู ุนููู:</b> ${o.remaining}$<br><hr>
        <b style="color:red;">โ๏ธ ุฏููู ุณุงุจูุฉ:</b> ${oldDebt}$<br>
        <b style="color:green; font-size:1.1rem;">๐ฅ ุงูุฅุฌูุงูู ุงูููุงุฆู: ${oldDebt + o.remaining}$</b>
    `;
    document.getElementById('customConfirm').style.display = 'flex';

    // ุนูุฏ ุงูุถุบุท ุนูู ุชุฃููุฏ
    document.getElementById('okBtn').onclick = async () => {
        document.getElementById('customConfirm').style.display = 'none';

        // 1. ุชุฑุญูู ุงูุฏููู (ูุน ุญูุธ ุงูุฑูู)
        if (o.remaining > 0) {
            if (debtDocId) {
                await updateDoc(doc(db, "debts", debtDocId), { 
                    amount: oldDebt + o.remaining, 
                    phone: o.phone || "ุจุฏูู ุฑูู", // ุชุญุฏูุซ ุงูุฑูู ูู ุญุงู ุชุบูุฑ
                    date: new Date() 
                });
            } else {
                await addDoc(collection(db, "debts"), { 
                    customer: o.customer, 
                    phone: o.phone || "ุจุฏูู ุฑูู", 
                    amount: o.remaining, 
                    date: new Date() 
                });
            }
        }

        // 2. ุฎุตู ุงููุฎุฒู ูุจูุงุก ุงููุงุชูุฑุฉ
        let itemsHtml = "";
        for (const item of o.items) {
            const pRef = doc(db, "products", item.productId);
            const pSnap = await getDoc(pRef);
            if (pSnap.exists()) {
                await updateDoc(pRef, { stock: Math.max(0, pSnap.data().stock - item.quantity) });
                itemsHtml += `<tr style="border-bottom:1px solid #eee;"><td style="padding:10px;">${item.name}</td><td style="text-align:center;">${item.quantity}</td><td style="text-align:center;">${item.price}$</td></tr>`;
            }
        }

        // 3. ุทุจุงุนุฉ ุงููุงุชูุฑุฉ
        const totalDebtNow = oldDebt + o.remaining;
        const printWin = window.open('', '_blank');
        printWin.document.write(`
            <div dir="rtl" style="font-family:Arial; border:2px solid #d4af37; padding:20px; border-radius:15px; max-width:500px; margin:auto;">
                <h2 style="text-align:center; color:#d4af37;">โ๏ธ ูุงุชูุฑุฉ ุงูุฅูุจุฑุงุทูุฑูุฉ โ๏ธ</h2>
                <p><b>ุงูุนููู:</b> ${o.customer} | <b>ุงููุงุชู:</b> ${o.phone || '---'}</p>
                <table style="width:100%; border-collapse:collapse; margin:15px 0;">
                    <thead><tr style="background:#eee;"><th>ุงูุตูู</th><th>ุงููููุฉ</th><th>ุงูุณุนุฑ</th></tr></thead>
                    <tbody>${itemsHtml}</tbody>
                </table>
                <div style="background:#f9f9f9; padding:10px; border-radius:10px;">
                    <p>๐ฐ ุฅุฌูุงูู ุงูุทูุจ: ${o.total}$ | โ ุงููุฏููุน: ${o.paid}$</p>
                    <p style="color:red;">โ๏ธ ุงููุชุจูู ุงูุขู: ${o.remaining}$</p>
                    <p>๐ ุฏูู ุณุงุจู: ${oldDebt}$</p>
                    <hr><p style="font-size:1.2rem;"><b>๐ฅ ุฅุฌูุงูู ูุฏููููุชู: ${totalDebtNow}$</b></p>
                </div>
                <div style="margin-top:20px; text-align:center;">
                    <button onclick="window.print()">ุทุจุงุนุฉ ๐จ๏ธ</button>
                    <button onclick="window.open('https://wa.me/${o.phone}?text=' + encodeURIComponent('ูุงุชูุฑุฉ ุฅูุจุฑุงุทูุฑูุฉ ุงูุณูุงุฑู โ๏ธ\\nุงููุฌููุน ุงูููู ูุฏููู: ${totalDebtNow}$'))">ูุงุชุณุงุจ ๐ฑ</button>
                </div>
            </div>
        `);
        printWin.document.close();

        // 4. ุญุฐู ุงูุทูุจ ูุชุณุฌูู ุงููุงุชูุฑุฉ
        // ุงุจุญุซ ุนู ูุฐุง ุงูุณุทุฑ ูู ููุฏู ูุนุฏูู ููุญูุธ ุงูุฃุตูุงู ุฏุงุฎู ุงููุงุชูุฑุฉ
await addDoc(collection(db, "invoices"), { 
    customer: o.customer, 
    total: o.total, 
    items: o.items, // ูุฐุง ุงูุณุทุฑ ูู "ุงูุจูุงุฑุงุช" ุงููู ูุงูุช ูุงูุตุฉ!
    date: new Date() 
});

         await deleteDoc(orderRef);
        alert("ุชู ุงูุชุฑุญูู ูุชุฌููุฒ ุงููุงุชูุฑุฉ! โ");
    };
};
let topSellingItems = [];
onSnapshot(collection(db, "invoices"), (snap) => {
    let itemStats = {};
    snap.forEach(doc => {
        const inv = doc.data();
        // ุฑุงุฏุงุฑ ูุจุญุซ ุนู ุฃู ูุตูููุฉ ุฃุตูุงู
        const productsList = inv.items || inv.products || []; 
        if (Array.isArray(productsList)) {
            productsList.forEach(item => {
                const itemName = item.name || item.title || "ุตูู ูุฌููู";
                const itemQty = Number(item.qty || item.quantity || 1);
                itemStats[itemName] = (itemStats[itemName] || 0) + itemQty;
            });
        }
    });

    topSellingItems = Object.entries(itemStats)
        .map(([name, qty]) => ({ name, qty }))
        .sort((a, b) => b.qty - a.qty);

    const bestSellerEl = document.getElementById('bestSellerName');
    if (topSellingItems.length > 0) {
        bestSellerEl.innerText = topSellingItems[0].name;
    } else {
        bestSellerEl.innerText = "ุจุฅูุชุธุงุฑ ุฃูู ุจูุนุฉ.. ๐"; 
    }
});


    

//////////////////////////

// --- 2. ูุธุงู ุงููุฑุงูุจุฉ ุงูุญูุฉ (onSnapshot) ูุธููุฑ ุงูุทูุจุงุช ููุฑุงู ---
// --- 2. ูุธุงู ุงููุฑุงูุจุฉ ุงูุญูุฉ (onSnapshot) ูุธููุฑ ุงูุทูุจุงุช ููุฑุงู ูุน ุงูุฑูู ---
onSnapshot(collection(db, "orders"), (snap) => {
    document.getElementById('orderCount').innerText = snap.size;
    const container = document.getElementById('ordersContainer');
    container.innerHTML = snap.size === 0 ? "ูุง ุชูุฌุฏ ุทูุจุงุช.." : "";
    
    snap.forEach((docBox) => {
        const o = docBox.data();
        const id = docBox.id;
        container.innerHTML += `
            <div style="border-bottom:1px solid #eee; padding:10px 0;">
                <b>๐ค ${o.customer}</b><br>
                <span style="color:blue; font-size:0.8rem;">๐ ุฑูู ุงูุนููู: ${o.phone || "ุจุฏูู ุฑูู"}</span><br>
                ๐ฐ ุงูุฅุฌูุงูู: ${o.total}$
                <div class="order-btn-group" style="display:flex; gap:5px; margin-top:5px;">
                    <button class="btn-confirm" style="background:#27ae60; color:white; border:none; padding:5px; border-radius:5px; flex:1; cursor:pointer;" onclick="processOrder('${id}', 'confirm')">ุชุฃููุฏ โ</button>
                    <button class="btn-reject" style="background:#e74c3c; color:white; border:none; padding:5px; border-radius:5px; flex:1; cursor:pointer;" onclick="processOrder('${id}', 'reject')">ุฑูุถ โ</button>
                </div>
            </div>`
    });
});

function showNotif(msg) {
    const n = document.getElementById('notif');
    document.getElementById('notif-text').innerText = msg;
    n.style.display = 'flex';
    setTimeout(() => { n.style.display = 'none'; }, 4000); 
}
// ูุตูููุฉ ูุชุฎุฒูู ุงูููุงูุต ูุคูุชุงู
// ูุตูููุฉ ุนุงูููุฉ ูุชุฎุฒูู ุงูููุงูุต ููู ุชุณุชุฎุฏููุง ุงููุงูุฐุฉ ุงูููุจุซูุฉ
let lowStockItems = [];

// ุงููุญุฑู ุงูุฑุฆูุณู: ูุฑุงูุจ ุงููุฎุฒู ููุญุฏุซ ุงูุฃุฑูุงู ููุฑุงู
onSnapshot(collection(db, "products"), (s) => {  
    let tc = 0, tp = 0, count = 0;  
    let lowCount = 0;
    lowStockItems = []; // ุชุตููุฑ ุงููุงุฆูุฉ ูุจุฏุก ุญุณุงุจ ุฌุฏูุฏ

    s.forEach(d => {  
        const p = d.data(); 
        const stock = Number(p.stock) || 0;
        const cost = Number(p.cost) || 0;
        const price = Number(p.price) || 0;

        // 1. ุญุณุงุจุงุช ููุญุฉ ุงูุชุญูู (ุงููุฏููุฉ)
        tc += (cost * stock); 
        tp += ((price - cost) * stock);  
        count++;  

        // 2. ูุญุต ุงูููุงูุต (ุฃูู ูู 50 ูุฑุชูู)
        if (stock < 50) {
            lowCount++;
            lowStockItems.push({ name: p.name, stock: stock });
        }

        // 3. ุชูุจูู ุตูุชู ูู ุงูุตูู "ุฎุทุฑ" (ุฃูู ูู 5)
        if (stock <= 5 && stock > 0) {
            speak(`ุชูุจููุ ุตูู ${p.name} ุดุงุฑู ุนูู ุงูุงูุชูุงุก`);
        }
    });  

    // ุชุญุฏูุซ ุงูุฃุฑูุงู ูู ุงูุดุงุดุฉ (ุชุฃูุฏ ุฃู ุงูู IDs ูุทุงุจูุฉ)
    if(document.getElementById('totalCosts')) document.getElementById('totalCosts').innerText = tc.toFixed(2) + "$";  
    if(document.getElementById('netProfit')) document.getElementById('netProfit').innerText = tp.toFixed(2) + "$";  
    document.getElementById('itemCount').innerText = count;  
    document.getElementById('lowStockCount').innerText = lowCount; // ุฑูู ุงูููุงูุต
    document.getElementById('uniqueProducts').innerText = count;   // ุชููุน ุงูุฃุตูุงู
});
///////////////////
    // ูุตูููุฉ ูุชุฎุฒูู ุชุฑุชูุจ ุงูุนููุงุก
let topCustomersList = [];

// ูุญุฑู ูุฑุงูุจุฉ ุงูููุงุชูุฑ ูุญุณุงุจ ุฃูุถู ุงูุนููุงุก
onSnapshot(collection(db, "invoices"), (snap) => {
    let customerStats = {};
    
    snap.forEach(doc => {
        const inv = doc.data();
        const name = inv.customer || "ูุฌููู";
        const total = Number(inv.total) || 0;
        
        if (!customerStats[name]) customerStats[name] = 0;
        customerStats[name] += total;
    });

    // ุชุญููู ุงููุงุฆู ููุตูููุฉ ูุฑุชุจุฉ
    topCustomersList = Object.entries(customerStats)
        .map(([name, total]) => ({ name, total }))
        .sort((a, b) => b.total - a.total);

    // ุชุญุฏูุซ ุงูุจุทุงูุฉ ุงูุฑุฆูุณูุฉ ุจุฃูุถู ุนููู
    if (topCustomersList.length > 0) {
        document.getElementById('topCustomerName').innerText = topCustomersList[0].name;
        document.getElementById('topCustomerAmount').innerText = "ุจุฅุฌูุงูู: " + topCustomersList[0].total.toFixed(2) + "$";
    }
});

// ุฏุงูุฉ ุฅุธูุงุฑ ุงููุงุฆูุฉ ุงูููุจุซูุฉ ููุฃูุงุฆู
    onSnapshot(collection(db, "invoices"), (snap) => {
    let itemStats = {};
    
    snap.forEach(doc => {
        const inv = doc.data();
        
        // ุงูุฑุงุฏุงุฑ: ูุจุญุซ ุนู ุฃู ูุตูููุฉ (Array) ุฏุงุฎู ุงููุงุชูุฑุฉ ูููุง ูุงู ุงุณููุง
        const arrayKey = Object.keys(inv).find(key => Array.isArray(inv[key]));
        
        if (arrayKey) {
            inv[arrayKey].forEach(item => {
                // ูุจุญุซ ุนู ุฃู ุญูู ูุตู ููุงุณู ูุฃู ุฑูู ูููููุฉ
                const itemName = item.name || item.title || item.productName || Object.values(item).find(v => typeof v === 'string');
                const itemQty = Number(item.qty || item.quantity || item.count || Object.values(item).find(v => typeof v === 'number') || 1);
                
                if (itemName) {
                    itemStats[itemName] = (itemStats[itemName] || 0) + itemQty;
                }
            });
        }
    });

    topSellingItems = Object.entries(itemStats)
        .map(([name, qty]) => ({ name, qty }))
        .sort((a, b) => b.qty - a.qty);

    const bestSellerEl = document.getElementById('bestSellerName');
    if (topSellingItems.length > 0) {
        bestSellerEl.innerText = topSellingItems[0].name;
    } else {
        bestSellerEl.innerText = "ุงูุจุถุงุนุฉ ูู ุงููุฎุฒู!"; 
    }
});
// ุฏุงูุฉ ุฅุธูุงุฑ ูุงูุฐุฉ ุงูุฃูุซุฑ ูุจูุนุงู
window.showTopSelling = () => {
    const listDiv = document.getElementById('topSellingList');
    const modal = document.getElementById('topSellingModal');
    
    if (topSellingItems.length === 0) {
        listDiv.innerHTML = "<p style='text-align:center; padding:20px;'>ูุง ุชูุฌุฏ ุจูุงูุงุช ูุจูุนุงุช ูุณุฌูุฉ ุญุชู ุงูุขู.. ุงุจุฏุฃ ุจุงูุจูุน ุฃููุงู! ๐</p>";
    } else {
        // ุชุฑุชูุจ ุงููุงุฆูุฉ ูุนุฑุถูุง
        listDiv.innerHTML = topSellingItems.map((item, i) => `
            <div style="display:flex; justify-content:space-between; align-items:center; padding:15px; border-bottom:1px solid #eee; transition: 0.3s;">
                <span>
                    <span style="color:var(--gold); font-weight:bold; margin-left:10px;">#${i + 1}</span>
                    <b style="font-size: 1rem;">${item.name}</b>
                </span>
                <span style="background:var(--dark); color:var(--gold); padding:4px 12px; border-radius:15px; font-size:0.85rem; font-weight:bold;">
                    ุจููุน ูููุง: ${item.qty}
                </span>
            </div>
        `).join('');
    }
    
    modal.style.display = 'flex';
};


    window.showTopCustomers = () => {
    if (topCustomersList.length === 0) return alert("ูุง ุชูุฌุฏ ููุงุชูุฑ ูุณุฌูุฉ ุจุนุฏ!");
    
    let html = topCustomersList.slice(0, 5).map((c, i) => `
        <div style="display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid #eee;">
            <span>${i+1}. ๐ค <b>${c.name}</b></span>
            <span style="color:var(--green); font-weight:bold;">${c.total.toFixed(2)}$</span>
        </div>
    `).join('');

    // ุณูุณุชุฎุฏู ููุณ ููุฏุงู ุงูููุงูุต ูุชูููุฑ ุงููุณุงุญุฉ
    const listDiv = document.getElementById('lowStockList');
    const modal = document.getElementById('lowStockModal');
    
    document.querySelector('#lowStockModal div div').innerHTML = "๐๏ธ ูุงุฆูุฉ ูุจุงุฑ ุงูุนููุงุก (VIP)";
    listDiv.innerHTML = html;
    modal.style.display = 'flex';
};
let allVipCustomers = [];

// ูุญุฑู ูุฑุงูุจุฉ ุงููุจูุนุงุช ูุชุฑุชูุจ ุงูุฒุจุงุฆู
onSnapshot(collection(db, "invoices"), (snap) => {
    let stats = {};
    snap.forEach(doc => {
        const data = doc.data();
        const name = data.customer || "ุนููู ูุฌููู";
        stats[name] = (stats[name] || 0) + (Number(data.total) || 0);
    });

    // ุชุญููู ุงููุงุฆู ููุตูููุฉ ูุฑุชุจุฉ ูู ุงูุฃูุซุฑ ุดุฑุงุกู ููุฃูู
    allVipCustomers = Object.entries(stats)
        .map(([name, total]) => ({ name, total }))
        .sort((a, b) => b.total - a.total);

    // ุชุญุฏูุซ ุงูุจุทุงูุฉ ุงูุฑุฆูุณูุฉ ุจุงููุฑูุฒ ุงูุฃูู
    if (allVipCustomers.length > 0) {
        document.getElementById('topCustomerName').innerText = allVipCustomers[0].name;
        document.getElementById('topCustomerAmount').innerText = "ุจุฅุฌูุงูู: " + allVipCustomers[0].total.toFixed(2) + "$";
    }
});

// ุฏุงูุฉ ูุชุญ ูุงูุฐุฉ ุงูู VIP
window.showVipList = () => {
    const container = document.getElementById('vipListContent');
    if (allVipCustomers.length === 0) {
        container.innerHTML = "<p style='text-align:center;'>ูุง ููุฌุฏ ุจูุงูุงุช ูุจูุนุงุช ุจุนุฏ..</p>";
    } else {
        container.innerHTML = allVipCustomers.map((c, i) => `
            <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid #333; ${i === 0 ? 'background: rgba(212, 175, 55, 0.1);' : ''}">
                <span>
                    <span style="color:${i === 0 ? 'gold' : '#888'}; font-weight:bold; margin-left:10px;">#${i + 1}</span>
                    <b style="color:white;">${c.name}</b>
                </span>
                <span style="color:var(--green); font-weight:bold;">${c.total.toFixed(2)}$</span>
            </div>
        `).join('');
    }
    document.getElementById('vipModal').style.display = 'flex';
};

// ุฏุงูุฉ ุฅุธูุงุฑ ุงููุงูุฐุฉ ุงูููุจุซูุฉ ุนูุฏ ุงูุถุบุท ุนูู ุงูุจุทุงูุฉ ุงูุญูุฑุงุก
window.showLowStock = () => {
    const listDiv = document.getElementById('lowStockList');
    const modal = document.getElementById('lowStockModal');
    
    if (lowStockItems.length === 0) {
        listDiv.innerHTML = "<p style='text-align:center; padding:20px;'>โ ุงููุฎุฒู ุนุงูุฑ ููู ุงูุฃุตูุงู ูุชููุฑุฉ!</p>";
    } else {
        listDiv.innerHTML = lowStockItems.map(item => `
            <div style="display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid #eee; font-weight:bold;">
                <span>๐ฆ ${item.name}</span>
                <span style="color:var(--red);">ุจุงูู: ${item.stock}</span>
            </div>
        `).join('');
    }
    modal.style.display = 'flex';
};

// ุฏุงูุฉ ุฅุฑุณุงู ุงูููุงูุต ุนุจุฑ ุงููุงุชุณุงุจ
window.shareLowStock = () => {
    if (lowStockItems.length === 0) return alert("ุงููุฎุฒู ุนุงูุฑ ูุง ููุฌุฏ ููุงูุต!");
    
    let message = "๐ฆ *ูุงุฆูุฉ ููุงูุต ูุฎุฒู ุงูุณูุงุฑู* ๐ฆ%0A";
    message += "----------------------------%0A";
    lowStockItems.forEach((item, index) => {
        message += `${index + 1}- ${item.name} (ุงููุชุจูู: ${item.stock})%0A`;
    });
    message += "----------------------------%0A";
    message += "ูุฑุฌู ุชุฌููุฒ ุงูุทูุจูุฉ ููุฑุงู โ๏ธ";

    window.open(`https://wa.me/?text=${message}`, '_blank');
};

// ุฏุงูุฉ ุทุจุงุนุฉ ุงูููุงูุต ููุท
window.printLowStock = () => {
    if (lowStockItems.length === 0) return;

    const printWin = window.open('', '_blank');
    let tableRows = lowStockItems.map((item, i) => `
        <tr>
            <td>${i + 1}</td>
            <td>${item.name}</td>
            <td>${item.stock}</td>
        </tr>`).join('');

    printWin.document.write(`
        <div dir="rtl" style="font-family:Arial; padding:20px;">
            <h2 style="text-align:center;">๐ ูุดู ููุงูุต ุงููุฎุฒู - ุงูุณูุงุฑู</h2>
            <table border="1" style="width:100%; border-collapse:collapse; text-align:center;">
                <thead><tr style="background:#eee;"><th>ู</th><th>ุงุณู ุงูุตูู</th><th>ุงููููุฉ ุงูุญุงููุฉ</th></tr></thead>
                <tbody>${tableRows}</tbody>
            </table>
        </div>
    `);
    printWin.document.close();
    printWin.print();
};

    
</script>  
    <!-- ุฅุดุนุงุฑ ุนุงู (ุฎุงุฑุฌ ุฃู modal) -->
<div id="notif"
     style="display:none;
            position:fixed;
            bottom:20px;
            left:50%;
            transform:translateX(-50%);
            background:#121212;
            color:#d4af37;
            padding:15px 25px;
            border-radius:12px;
            box-shadow:0 4px 15px rgba(0,0,0,0.3);
            z-index:99999;
            font-weight:bold;">
    <span id="notif-text"></span>
    <button onclick="document.getElementById('notif').style.display='none';"
            style="margin-left:15px;
                   background:#27ae60;
                   color:white;
                   border:none;
                   border-radius:6px;
                   padding:5px 10px;
                   cursor:pointer;">
      
    </button>
</div>
    <div id="lowStockModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center;">
    <div style="background:white; width:90%; max-width:500px; border-radius:15px; overflow:hidden; border:2px solid var(--gold); position:relative;">
        <div style="background:var(--dark); color:var(--gold); padding:15px; text-align:center; font-weight:bold;">
            โ๏ธ ูุงุฆูุฉ ุงูููุงูุต (ุฃูู ูู 50 ูุฑุชูู)
            <span onclick="document.getElementById('lowStockModal').style.display='none'" style="position:absolute; left:15px; cursor:pointer; font-size:1.5rem;">ร</span>
        </div>
        <div id="lowStockList" style="max-height:350px; overflow-y:auto; padding:15px;"></div>
        
        <div style="display:flex; gap:10px; padding:15px; border-top:1px solid #eee; background:#f9f9f9;">
            <button onclick="printLowStock()" style="flex:1; background:var(--dark); color:var(--gold); border:1px solid var(--gold); padding:10px; border-radius:8px; font-weight:bold; cursor:pointer;">๐จ๏ธ ุทุจุงุนุฉ</button>
            <button onclick="shareLowStock()" style="flex:1; background:#25D366; color:white; border:none; padding:10px; border-radius:8px; font-weight:bold; cursor:pointer;">๐ฑ ูุงุชุณุงุจ</button>
        </div>
    </div>
</div>
<div id="customConfirm" class="confirm-box" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center;">
    <div class="confirm-content" style="background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; border: 3px solid var(--gold); text-align: center; color: var(--dark);">
        <h3 style="color: var(--gold); margin-top: 0;">๐ ูุฑุงุฌุนุฉ ูุชุฃููุฏ ุงูุทูุจ</h3>
        <div id="confirmBody" style="text-align: right; line-height: 1.8; margin-bottom: 20px; font-size: 0.95rem;">
            </div>
        <div class="confirm-btns" style="display: flex; gap: 10px;">
            <button id="okBtn" style="flex: 1; padding: 12px; background: var(--green); color: white; border-radius: 10px; border: none; font-weight: bold; cursor: pointer;">ุชุฃููุฏ ูุชุฑุญูู โ</button>
            <button onclick="document.getElementById('customConfirm').style.display='none'" style="flex: 1; padding: 12px; background: var(--red); color: white; border-radius: 10px; border: none; font-weight: bold; cursor: pointer;">ุฅูุบุงุก โ</button>
        </div>
    </div>
</div>


</body>  
</html>
    