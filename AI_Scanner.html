<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ù…Ø®Ø²Ù† Ø§Ù„Ø³ÙŠØ§Ø±ÙŠ | Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        :root { --gold: #d4af37; --dark: #0a0a0a; --gold-light: #f1d592; --glass: rgba(255, 255, 255, 0.1); }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0f0f0f; color: #fff; margin: 0; padding: 20px; overflow-x: hidden; }
        
        /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø®Ù„ÙÙŠØ© */
        body::before { content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 50% 50%, #1a1a1a 0%, #000 100%); z-index: -1; }

        .header { text-align: center; padding: 30px; background: var(--glass); backdrop-filter: blur(10px); border-radius: 20px; border: 1px solid var(--gold); margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .header h1 { margin: 0; color: var(--gold); text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 10px var(--gold); }

        .upload-area { border: 2px dashed var(--gold); border-radius: 20px; padding: 40px; text-align: center; transition: 0.3s; background: rgba(212, 175, 55, 0.05); cursor: pointer; }
        .upload-area:hover { background: rgba(212, 175, 55, 0.1); transform: scale(1.01); }
        
        .scan-btn { background: linear-gradient(45deg, var(--dark), #222); color: var(--gold); padding: 18px 30px; border: 1px solid var(--gold); border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 1.2rem; transition: 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .scan-btn:hover { background: var(--gold); color: var(--dark); box-shadow: 0 0 20px var(--gold); }

        /* Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ù„Ù„Ø´Ø­Ù† */
        #loader-container { display: none; margin-top: 20px; }
        .progress-bar { width: 100%; height: 10px; background: #222; border-radius: 5px; overflow: hidden; position: relative; }
        .progress-fill { width: 0%; height: 100%; background: var(--gold); transition: 0.4s; box-shadow: 0 0 10px var(--gold); }

        #results { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-top: 30px; }
        .item-card { background: #1a1a1a; padding: 20px; border-radius: 15px; border-top: 4px solid var(--gold); position: relative; animation: fadeInUp 0.5s; }
        
        .status-badge { position: absolute; top: -12px; left: 20px; background: var(--gold); color: #000; padding: 2px 12px; border-radius: 10px; font-size: 0.75rem; font-weight: bold; }

        input { background: #222; border: 1px solid #333; color: #fff; padding: 12px; border-radius: 10px; width: 100%; box-sizing: border-box; margin-top: 8px; transition: 0.3s; }
        input:focus { border-color: var(--gold); outline: none; background: #2a2a2a; }

        .btn-save { background: #27ae60; color: white; border: none; padding: 15px; border-radius: 10px; font-weight: bold; width: 100%; cursor: pointer; margin-top: 15px; transition: 0.3s; }
        .btn-save:hover { background: #2ecc71; transform: translateY(-2px); }

        .toast { position: fixed; bottom: 20px; right: 20px; background: var(--gold); color: #000; padding: 15px 25px; border-radius: 10px; font-weight: bold; display: none; z-index: 9999; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

<div class="header animate__animated animate__fadeInDown">
    <h1>âšœï¸ Ø¹Ù‚Ù„ Ø§Ù„Ø³ÙŠØ§Ø±ÙŠ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ âšœï¸</h1>
    <p>Ø¨ÙˆØ§Ø¨ØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙˆØ±ÙŠØ¯ ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ</p>
</div>

<div class="upload-area animate__animated animate__fadeInUp" onclick="document.getElementById('master-input').click()">
    <input type="file" id="master-input" accept="image/*,application/pdf" style="display:none">
    <div id="upload-text">
        <span style="font-size: 3rem;">ğŸ“„</span>
        <h3>Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø±ÙØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</h3>
        <p>ÙŠØ¯Ø¹Ù… Ø§Ù„ØµÙˆØ± Ø¹Ø§Ù„Ø¨Ø© Ø§Ù„Ø¬ÙˆØ¯Ø© ÙˆÙ…Ù„ÙØ§Øª PDF</p>
    </div>
    
    <div id="loader-container">
        <p id="status-text">Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª... â³</p>
        <div class="progress-bar"><div class="progress-fill" id="p-fill"></div></div>
    </div>
</div>

<div id="results"></div>
<div id="toast" class="toast"></div>

<canvas id="pdf-canvas" style="display:none;"></canvas>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

    const firebaseConfig = { /* Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù‡Ù†Ø§ */ apiKey: "AIzaSyAD5GAic-ioZhetXQQ4u8shXScxTZO2DoI", authDomain: "elite-store-8f693.firebaseapp.com", projectId: "elite-store-8f693", storageBucket: "elite-store-8f693.firebasestorage.app", messagingSenderId: "227353365436", appId: "1:227353365436:web:e662600dac0e83fe6739b9" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const fileInput = document.getElementById('master-input');
    const resultsDiv = document.getElementById('results');

    fileInput.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        document.getElementById('upload-text').style.display = "none";
        document.getElementById('loader-container').style.display = "block";
        resultsDiv.innerHTML = "";
        
        let source = (file.type === "application/pdf") ? await convertPdfToImage(file) : file;
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Tesseract v5 Ù…Ø¹ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
        const { data: { lines } } = await Tesseract.recognize(source, 'ara+eng', {
            logger: m => {
                if(m.status === 'recognizing text') {
                    document.getElementById('p-fill').style.width = (m.progress * 100) + "%";
                }
            }
        });

        await smartParser(lines);
        
        document.getElementById('loader-container').style.display = "none";
        document.getElementById('upload-text').style.display = "block";
    };

    async function smartParser(lines) {
        const ignoreList = ["ÙØ§ØªÙˆØ±Ø©", "total", "Ù…Ø¬Ù…ÙˆØ¹", "tax", "Ø¶Ø±ÙŠØ¨Ø©", "Ø¹Ù†ÙˆØ§Ù†", "Ø±Ù‚Ù…"];

        for (const lineObj of lines) {
            const text = lineObj.text.trim();
            const nums = text.match(/(\d+(\.\d+)?)/g) || [];
            
            // Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© ØªØµÙÙŠØ© Ø§Ù„Ø£Ø³Ø·Ø± ØºÙŠØ± Ø§Ù„Ù…Ù‡Ù…Ø©
            if (text.length > 4 && nums.length >= 1 && !ignoreList.some(word => text.toLowerCase().includes(word))) {
                
                // Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø¨Ø³ÙŠØ·: Ø§Ù„Ø§Ø³Ù… Ù‡Ùˆ Ø§Ù„Ù†ØµØŒ ÙˆØ§Ù„Ø§Ø±Ù‚Ø§Ù… Ù‡ÙŠ Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„ÙƒÙ…ÙŠØ©
                let name = text.replace(/[0-9.]/g, "").replace(/[^\w\s\u0600-\u06FF]/g, "").trim();
                let price = parseFloat(nums[nums.length - 1]); // Ø§Ù„Ø³Ø¹Ø± ØºØ§Ù„Ø¨Ø§Ù‹ Ø¢Ø®Ø± Ø±Ù‚Ù…
                let qty = nums.length > 1 ? parseInt(nums[0]) : 1; // Ø§Ù„ÙƒÙ…ÙŠØ© ØºØ§Ù„Ø¨Ø§Ù‹ Ø£ÙˆÙ„ Ø±Ù‚Ù…

                if (name.length > 2) {
                    const stockData = await checkFirebase(name);
                    renderCard(name, price, qty, stockData);
                }
            }
        }
    }

    async function checkFirebase(name) {
        const q = query(collection(db, "products"), where("name", "==", name));
        const snap = await getDocs(q);
        if (!snap.empty) {
            const d = snap.docs[0];
            return { id: d.id, currentStock: d.data().stock, exists: true };
        }
        return { exists: false };
    }

        function renderCard(name, price, qty, stock) {
        const card = document.createElement('div');
        card.className = "item-card animate__animated animate__zoomIn";
        card.innerHTML = `
            <span class="status-badge">${stock.exists ? 'Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„Ù…Ø®Ø²Ù†' : 'ØµÙ†Ù Ø¬Ø¯ÙŠØ¯'}</span>
            <label>ğŸ“¦ Ø§Ù„ØµÙ†Ù</label>
            <input type="text" value="${name}" class="inp-name">
            
            <div style="display:flex; gap:10px; margin-top:10px;">
                <div style="flex:1"><label>ğŸ’° Ø§Ù„Ø³Ø¹Ø±/Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</label><input type="number" step="0.01" value="${price}" class="inp-price"></div>
                <div style="flex:1"><label>ğŸ”¢ Ø§Ù„ÙƒÙ…ÙŠØ©</label><input type="number" value="${qty}" class="inp-qty"></div>
            </div>

            <p style="font-size: 0.8rem; color: #888; margin-top:10px;">
                ${stock.exists ? `Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ: ${stock.currentStock} â¬…ï¸ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©: ${Number(stock.currentStock) + Number(qty)}` : 'Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯'}
            </p>

            <div style="display:flex; gap:8px; margin-top:15px;">
                <button class="btn-save" style="flex:3; margin-top:0;" onclick="processSave(this, '${stock.id || 'new'}', ${stock.currentStock || 0})">
                    ${stock.exists ? 'ØªØ­Ø¯ÙŠØ« âš¡' : 'Ø¥Ø¶Ø§ÙØ© âœ…'}
                </button>
                
                <button title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ…" style="flex:1; background:var(--blue); color:white; border:none; border-radius:10px; cursor:pointer;" onclick="swapValues(this)">ğŸ”„</button>
                
                <button title="ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø³Ø¹Ø± Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ…ÙŠØ©" style="flex:1; background:#9b59b6; color:white; border:none; border-radius:10px; cursor:pointer; font-weight:bold; font-size:1.2rem;" onclick="dividePrice(this)">â—</button>
                
                <button title="Ø­Ø°Ù" style="flex:1; background:var(--red); color:white; border:none; border-radius:10px; cursor:pointer;" onclick="this.closest('.item-card').remove()">âŒ</button>
            </div>
        `;
        resultsDiv.appendChild(card);
    }

    // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ ğŸ”„
    window.swapValues = (btn) => {
        const card = btn.closest('.item-card');
        const p = card.querySelector('.inp-price');
        const q = card.querySelector('.inp-qty');
        [p.value, q.value] = [q.value, p.value];
    };

    // Ø¯Ø§Ù„Ø© Ø§Ù„Ù‚Ø³Ù…Ø© Ø§Ù„Ø°ÙƒÙŠØ© â— (Ø§Ù„Ù…ÙŠØ²Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
    window.dividePrice = (btn) => {
        const card = btn.closest('.item-card');
        const p = card.querySelector('.inp-price');
        const q = card.querySelector('.inp-qty');
        
        let totalPrice = parseFloat(p.value);
        let quantity = parseFloat(q.value);

        if (quantity > 0) {
            p.value = (totalPrice / quantity).toFixed(2);
            showToast("ØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ø³Ø¹Ø± Ø§Ù„Ø­Ø¨Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø© ğŸ¯");
        } else {
            alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ù‚Ø³Ù…Ø© Ø¹Ù„Ù‰ ØµÙØ± ÙŠØ§ Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±! âš ï¸");
        }
    };


    window.processSave = async (btn, docId, oldStock) => {
        const card = btn.closest('.item-card');
        const n = card.querySelector('.inp-name').value;
        const p = parseFloat(card.querySelector('.inp-price').value);
        const q = parseInt(card.querySelector('.inp-qty').value);

        btn.disabled = true;
        btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";

        try {
            if (docId === 'new') {
                await addDoc(collection(db, "products"), { name: n, cost: p, stock: q, price: (p * 1.25).toFixed(2), date: new Date().toISOString() });
            } else {
                await updateDoc(doc(db, "products", docId), { stock: Number(oldStock) + q, cost: p });
            }
            showToast(`ØªÙ… Ø­ÙØ¸ ${n} Ø¨Ù†Ø¬Ø§Ø­! ğŸ†`);
            card.classList.add('animate__fadeOutRight');
            setTimeout(() => card.remove(), 500);
        } catch (e) {
            alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…!");
            btn.disabled = false;
        }
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.style.display = "block";
        setTimeout(() => t.style.display = "none", 3000);
    }

    async function convertPdfToImage(file) {
        const pdf = await pdfjsLib.getDocument(URL.createObjectURL(file)).promise;
        const page = await pdf.getPage(1);
        const canvas = document.getElementById('pdf-canvas');
        const viewport = page.getViewport({ scale: 2 });
        canvas.height = viewport.height; canvas.width = viewport.width;
        await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
        return canvas.toDataURL();
    }
</script>

</body>
</html>
